#!/usr/bin/env bash 

set -e

cd "$(dirname "$0")"
initial_dir=$(pwd)

# Check if --pull flag is passed
pull_flag=false
if [[ $1 == "--pull" ]]; then
    pull_flag=true
fi

for dir in ./repos/*; do
    # echo "Checking $dir"
    if [[ -d "$dir" ]]; then
        cd "$dir"

        # Format the directory name
        dir=$(printf "%-20s" "$dir")
        echo -n "$dir: "

        # check if the directory is a git repo
        if [[ ! -d ".git" ]]; then
            echo "ğŸ”¸ not a git repo"
            cd "$initial_dir"
            continue
        fi
        # check if the git repo is dirty
        if [[ $(git diff --stat) != '' ]]; then
            echo "ğŸ”¸ repo has uncommitted changes"
            cd "$initial_dir"
            continue
        fi
        # check if repo has a main branch or master branch
        main_or_master=""
        if [[ $(git branch --list main) ]]; then
            main_or_master="main"
        elif [[ $(git branch --list master) ]]; then
            main_or_master="master"
        else
            echo "ğŸ”¸ no main or master branch"
            cd "$initial_dir"
            continue
        fi

        # check if repo has an upstream or origin remote
        upstream_or_origin=""
        if [[ $(git remote -v | grep upstream) ]]; then
            upstream_or_origin="upstream"
        elif [[ $(git remote -v | grep origin) ]]; then
            upstream_or_origin="origin"
        else
            echo "ğŸ”¸ no upstream or origin remote"
            cd "$initial_dir"
            continue
        fi

        git fetch "$upstream_or_origin" "$main_or_master" 2>/dev/null

        # if repo is not on main or master branch, don't do anything
        if [[ $(git branch --show-current) != "$main_or_master" ]]; then
            echo "ğŸ”¸ not on $main_or_master branch."
            cd "$initial_dir"
            continue
        fi
        # check if repo is up to date
        if [[ $(git rev-list HEAD...upstream/$main_or_master --count) -eq 0 ]]; then
            echo "âœ… up to date"
            cd "$initial_dir"
            continue
        fi

        if [[ $pull_flag == true ]]; then
            echo -n "pulling changes..."
            git pull 2>/dev/null && echo "âœ… done" || echo "âŒ failed"
        else 
            echo "ğŸ”¸ behind by $(git rev-list HEAD...upstream/$main_or_master --count) commits."
        fi

        cd "$initial_dir"
    fi
done
